# Erik-VPN: VLESS + Reality

services:
  # 3X-UI Panel с Xray-core
  xray-ui:
    image: ghcr.io/mhsanaei/3x-ui:latest
    container_name: erik-vpn
    restart: unless-stopped

    environment:
      # Xray конфигурация
      - XRAY_VMESS_AEAD_FORCED=false
      - XRAY_VER=latest

      # 3X-UI аутентификация
      # Важно: не даём Compose тихо стартовать с дефолтами (admin/admin),
      # если .env не подхватился или переменные не заданы.
      - XUI_USERNAME=${ADMIN_USERNAME:?set ADMIN_USERNAME in .env}
      - XUI_PASSWORD=${ADMIN_PASSWORD:?set ADMIN_PASSWORD in .env}

      # Базовый путь панели (для доступа по /air-erik-vpn/)
      - XUI_BASE_PATH=/air-erik-vpn/

    ports:
      # Панель управления 3X-UI
      - "${PANEL_PORT:-37428}:2053"

      # VLESS + Reality (основной протокол)
      - "${VLESS_REALITY_PORT:-443}:443"

      # VLESS + XHTTP (резервный протокол)
      - "${VLESS_XHTTP_PORT:-8080}:8080"

    volumes:
      # Данные 3X-UI (конфигурации, пользователи)
      - ./data/3x-ui:/etc/x-ui

      # Логи Xray
      - ./logs:/var/log/xray

    networks:
      - erik-vpn-net

    cap_add:
      - NET_ADMIN

    security_opt:
      - no-new-privileges:true

    # Проверка здоровья контейнера
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2053/air-erik-vpn/"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  erik-vpn-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
